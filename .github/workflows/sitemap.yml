name: Generate Sitemap

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2am
  workflow_dispatch:  # Allow manual triggering

jobs:
  sitemap:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # FIX: This allows the workflow to push changes
    
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Generate sitemap
        run: |
          # Find HTML files but EXCLUDE _layouts, _includes, and other Jekyll directories
          find . -name "*.html" -type f \
            ! -path "./_layouts/*" \
            ! -path "./_includes/*" \
            ! -path "./_site/*" \
            ! -path "./node_modules/*" \
            ! -path "./.git/*" \
            > files.txt
          
          # Start sitemap
          echo '<?xml version="1.0" encoding="UTF-8"?>' > sitemap.xml
          echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> sitemap.xml
          
          # Add each file to sitemap
          while read file; do
            url="https://maker404.com${file#.}"
            echo "  <url><loc>$url</loc></url>" >> sitemap.xml
          done < files.txt
          
          # Close sitemap
          echo '</urlset>' >> sitemap.xml
          
          # Show what we generated (for debugging)
          echo "Generated sitemap with $(cat files.txt | wc -l) URLs"
          
      - name: Commit sitemap
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add sitemap.xml
          
          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to sitemap"
          else
            git commit -m "Auto-update sitemap [skip ci]"
            git push
          fi
